configfile: "config.yaml"

# 全局参数校验
import os
assert os.path.exists(config["ref_genome"]), f"Ref genome {config['ref_genome']} not found!"
assert os.path.exists(config["germline_resource"]), "Germline resource not found!"
assert os.path.exists(config["panel_of_normals"]), "PON not found!"

rule all:
    input:
        "results/final.neoantigens.tsv",
        "results/versions.tsv",
        expand("qc/fastqc/{sample}_1_fastqc.html", sample=["tumor", "normal"])

# 1. 质控：FastQC
rule fastqc:
    input: r1 = "data/{sample}_1.fastq.gz", r2 = "data/{sample}_2.fastq.gz"
    output:
        html1 = "qc/fastqc/{sample}_1_fastqc.html",
        html2 = "qc/fastqc/{sample}_2_fastqc.html"
    threads: config["threads"]["fastqc"]
    log: "logs/fastqc/{sample}.log"
    shell:
        """
        set -euo pipefail
        fastqc -t {threads} {input.r1} {input.r2} -o qc/fastqc/ 2>&1 | tee {log}
        """

# 2. 比对 + 标记重复
rule align_and_dedup:
    input:
        r1 = "data/{sample}_1.fastq.gz",
        r2 = "data/{sample}_2.fastq.gz"
    output:
        bam = "bam/{sample}.sorted.dedup.bam",
        bai = "bam/{sample}.sorted.dedup.bam.bai"
    threads: config["threads"]["align"]
    params:
        ref = config["ref_genome"],
        tmp_dir = "tmp/{sample}"
    log: "logs/align/{sample}.log"
    shell:
        """
        set -euo pipefail
        mkdir -p {params.tmp_dir}
        bwa-mem2 mem -t {threads} {params.ref} {input.r1} {input.r2} | \
        sambamba view -S -f bam /dev/stdin | \
        sambamba sort -t {threads} --tmpdir {params.tmp_dir} -o {output.bam} --compression-level 6 /dev/stdin 2>&1 | tee {log}
        sambamba markdup -t {threads} --remove-duplicates {output.bam} {output.bam}.tmp
        mv {output.bam}.tmp {output.bam}
        sambamba index -t {threads} {output.bam}
        rm -rf {params.tmp_dir}
        """

# 3. 生成Mutect2区间
rule generate_intervals:
    output: "genome_intervals.list"
    params: ref = config["ref_genome"]
    log: "logs/generate_intervals.log"
    shell:
        """
        set -euo pipefail
        gatk SplitIntervals -R {params.ref} -O genome_intervals -L chr1-chr22,chrX,chrY --scatter-count 50 2>&1 | tee {log}
        ls genome_intervals/*.interval_list > {output}
        """

# 4. HLA分型
rule hla_typing:
    input:
        r1 = f"data/{config['samples']['tumor']}_1.fastq.gz",
        r2 = f"data/{config['samples']['tumor']}_2.fastq.gz"
    output: "results/hla/hla_results.tsv"
    params: config = "optitype_config.ini"
    threads: config["threads"]["hla"]
    log: "logs/hla_typing.log"
    shell:
        """
        set -euo pipefail
        optitype_pipeline.py -i {input.r1} {input.r2} -o results/hla/ \
            --threads {threads} --config {params.config} --enumerate 2 2>&1 | tee {log}
        """

# 5. Mutect2 scatter
rule mutect2_scatter:
    input:
        tumor = "bam/{tumor}.sorted.dedup.bam".format(tumor=config["samples"]["tumor"]),
        normal = "bam/{normal}.sorted.dedup.bam".format(normal=config["samples"]["normal"]),
        intervals = "genome_intervals.list"
    output: "vcf/mutect2/{interval}.vcf.gz"
    params:
        ref = config["ref_genome"],
        germline = config["germline_resource"],
        pon = config["panel_of_normals"]
    threads: config["threads"]["mutect2"]
    log: "logs/mutect2/{interval}.log"
    shell:
        """
        set -euo pipefail
        gatk Mutect2 \
            -R {params.ref} \
            -I {input.tumor} -tumor tumor \
            -I {input.normal} -normal normal \
            --germline-resource {params.germline} \
            --panel-of-normals {params.pon} \
            -L {wildcards.interval} \
            -O {output.vcf} \
            --native-pair-hmm-threads {threads} 2>&1 | tee {log}
        """

# 6. Mutect2 gather
rule mutect2_gather:
    input: expand("vcf/mutect2/{interval}.vcf.gz", interval=config["genome_intervals"])
    output: "vcf/somatic.vcf.gz"
    log: "logs/mutect2_gather.log"
    shell:
        """
        set -euo pipefail
        gatk MergeVcfs -I {input} -O {output} 2>&1 | tee {log}
        """

# 7. 新抗原预测
rule pvacseq:
    input:
        vcf = "vcf/somatic.vcf.gz",
        hla = "results/hla/hla_results.tsv"
    output: "results/final.neoantigens.tsv"
    params:
        sample_name = config["samples"]["tumor"],
        netmhc_dir = "$NETMHC_DIR",
        epitope_lengths = "8,9,10,11"
    threads: config["threads"]["pvacseq"]
    log: "logs/pvacseq.log"
    shell:
        """
        set -euo pipefail
        # 安全提取HLA等位基因
        if [ ! -s {input.hla} ]; then
            echo "ERROR: HLA typing result is empty!" && exit 1
        fi
        HLA_ALLELES=$(awk -F'\t' '
            NR==2 {{
                for(i=2;i<=7;i++) {{
                    gsub(/\*/, "", $i);
                    printf "%s,", $i
                }}
            }}
        ' {input.hla} | sed 's/,$//')
        
        if [ -z "$HLA_ALLELES" ]; then
            echo "ERROR: Failed to extract HLA alleles!" && exit 1
        fi
        
        pvacseq run \
            {input.vcf} \
            {params.sample_name} \
            "$HLA_ALLELES" \
            NetMHCpan \
            results/pvacseq/ \
            -e {params.epitope_lengths} \
            --iedb-install-directory {params.netmhc_dir} \
            --n-threads {threads} \
            --net-chop-method cterm \
            --netmhc-stab \
            --pass-only 2>&1 | tee {log}
        
        PVAC_OUTPUT="results/pvacseq/MHC_Class_I/{params.sample_name}.final.tsv"
        if [ ! -f "$PVAC_OUTPUT" ]; then
            echo "ERROR: pVACseq output $PVAC_OUTPUT not found!" && exit 1
        fi
        cp "$PVAC_OUTPUT" {output}
        """

# 8. 版本记录
rule check_versions:
    output: "results/versions.tsv"
    shell:
        """
        echo -e "tool\tversion" > {output}
        echo -e "bwa-mem2\t$(bwa-mem2 version | head -1)" >> {output}
        echo -e "sambamba\t$(sambamba --version | head -1)" >> {output}
        echo -e "optitype\t$(optitype_pipeline.py --version | head -1)" >> {output}
        echo -e "gatk\t$(gatk --version | grep "Version" | cut -d' ' -f2)" >> {output}
        echo -e "pvacseq\t$(pvacseq --version | head -1)" >> {output}
        """